package com.wb.component.computer.businessManage.controller;
import java.io.UnsupportedEncodingException;
import java.net.URLDecoder;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import org.apache.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;

import com.wb.component.computer.businessManage.service.IProcessInfoManageService;
import com.wb.component.computer.frameworkManage.service.IFrameworkManageService;
import com.wb.component.computer.login.service.ILoginService;
import com.wb.component.computer.processManage.service.IProcessManageService;
import com.wb.framework.commonResponse.AjaxAction;
import com.wb.framework.commonUtil.PageUtil;
import com.wb.framework.commonUtil.PageUtil.PageInfo;
import com.wb.framework.commonUtil.calendar.DateUtil;
import com.wb.model.entity.computer.MntMember;
import com.wb.model.entity.computer.MsgNotification;

@Controller
@RequestMapping(value = "business")
public class Business extends AjaxAction
{
    private static final Logger logger = Logger.getLogger(Business.class);
    
    /**
     * 流程管理Service层实例
     */
    @Autowired
    //@Qualifier("iProcessInfoManageService")
    private IProcessInfoManageService iProcessInfoManageService;
    
    
    /**
     * 流程管理Service层实例
     */
    @Autowired
    @Qualifier("processManageService")
    private IProcessManageService processManageService;
	 /**
     * 电脑端组织架构ser
     */
    @Autowired
    @Qualifier("frameworkManageService")
    private IFrameworkManageService frameworkSer;




    @Autowired()
    @Qualifier("loginService")
    private ILoginService cpuLoginSer;
    
    
    /**
     * 业务管理模块-跳转页面
     * 
     */
    @RequestMapping(value = "forward/gotoBusinessView", method = RequestMethod.GET)
    public String gotoBusinessView(HttpServletRequest request)
    {
        request.setAttribute("startDate", DateUtil.getCurYearFirstDate());
        request.setAttribute("endDate", DateUtil.getPrevTaxDate());
        //pageName：页面名称
        String pageName =request.getParameter("pageName");
        if("progress".equals(pageName)){//进度查询
            return "business/progressList";
        }else if("model".equals(pageName)){
        	 //业务模板
        	 return "business/businessModel";
        }else if("queryNode".equals(pageName)){
       	 //进入查看业务详细页面
         String proId = request.getParameter("proId");
         request.setAttribute("proId", proId);
       	 return "business/queryBusi";
       }else if("zhiPaiNodePage".equals(pageName)){
    	   //进入查看业务详细页面
           String proId = request.getParameter("proId");
           request.setAttribute("proId", proId);
         	 return "business/zhiPaiNodePage";
       }else if("editNamePage".equals(pageName)){
    	   //进入查看业务指派-编辑执行人姓名页面
           String proId = request.getParameter("proId");
           String nodeId = request.getParameter("nodeId");
           String departmentId = request.getParameter("departmentId");
           System.out.println("-------------departmentId:"+departmentId);
           request.setAttribute("proId", proId);
           request.setAttribute("nodeId", nodeId);
           request.setAttribute("departmentId", departmentId);
         	 //return "business/editName";
           return "business/frameworkManage";
       }else if("flowPage".equals(pageName)){
         	 //进入流程图页面
           String proId = request.getParameter("proId");
           request.setAttribute("proId", proId);
         	 return "business/flow";
        }else{
        	logger.info("-------没有该页面");
        	return "";
        }
        
    }
    
    /**
    * @Title: gotoBusinessModel 
    * @Description: 跳转到业务模板
    * @param @param request
    * @param @return
    * @author hechunyang 
    * @return String    返回类型 
    * @throws
     */
    @RequestMapping(value="forward/gotoBusinessModel",method=RequestMethod.GET)
    public String gotoBusinessModel(HttpServletRequest request){
    	return "business/businessModel";
    }
    
    
   /**
    * 
   * @Title: gotoBusinessModelNode 
   * @Description: TODO(这里用一句话描述这个方法的作用) 
   * @param @param modelId 模板的id
   * @param @param request
   * @param @return
   * @author hechunyang 
   * @return String    返回类型 
   * @throws
    */
    @RequestMapping(value="forward/gotoBusinessModelNode",method=RequestMethod.GET)
    public String gotoBusinessModelNode(String modelId,HttpServletRequest request){
    	
    	return "business/businessModel";
    }
   
    /***
    * @Title: gotoBusinesslNode 
    * @Description: 专供跳页面使用 
    * @param @param modelId
    * @param @param request
    * @param @return
    * @author hechunyang 
    * @return String    返回类型 
    * @throws
     */
    @RequestMapping(value="forward/gotoBusinesslNode",method=RequestMethod.GET)
    public String gotoBusinesslNode(String processTmpId,HttpServletRequest request){
    	request.setAttribute("processTmpId", processTmpId);
    	return "business/showNode";
    }
    
    /**
    * @Title: gotoBusinessModelShowNode 
    * @Description: TODO(这里用一句话描述这个方法的作用) 
    * @param @param processTmpId 模板id
    * @param @param request
    * @param @return
    * @author hechunyang 
    * @return String    返回类型 
    * @throws
     */
    @RequestMapping(value="forward/gotoBusinessModelShowNode",method=RequestMethod.POST)
    @ResponseBody
    public Map<String, Object> gotoBusinessModelShowNode(@RequestBody String processTmpId,HttpServletRequest request){
    	PageInfo pageInfo=new PageInfo(1, 50);
    	 final PageUtil util =processManageService.getModelNodeList(processTmpId,pageInfo);
    	return util.initResult();
    }
    
    
    /****
     * 
    * @Title: gotoBusinessModelAddNode 
    * @Description: 弹出框增加节点 
    * @param @param processTmpId
    * @param @param request
    * @param @return
    * @author hechunyang 
    * @return Map<String,Object>    返回类型 
    * @throws
     */
    @RequestMapping(value="forward/gotoBusinessModelAddNode",method=RequestMethod.POST)
    @ResponseBody
    public Map<String, Object> gotoBusinessModelAddNode( String processTmpId,HttpServletRequest request){
    	PageInfo pageInfo=new PageInfo(1, 10);
    	final PageUtil util =processManageService.getModelNodeList(processTmpId,pageInfo);
    	return util.initResult();
    }
    
    /**
    * @Title: saveNode 
    * @Description: TODO(这里用一句话描述这个方法的作用) 
    * @param @param id
    * @param @param request
    * @param @return
    * @author hechunyang 
    * @return Map<String,Object>    返回类型 
    * @throws
     */
    @RequestMapping(value="forward/saveNode",method=RequestMethod.POST)
    public  Map<String, Object> saveNode(String id,HttpServletRequest request){
    	Map<String, Object> result = new HashMap<String, Object>();
    	processManageService.addNodeInfo(id);
    	return result;
    }
    
    
    /***
     * 
    * @Title: gotoBusinesslAddNode 
    * @Description: 增加节点的小框 
    * @param @param id
    * @param @param request
    * @param @return
    * @author hechunyang 
    * @return Map<String,Object>    返回类型 
    * @throws
     */
    @RequestMapping(value="forward/gotoBusinesslAddNode",method=RequestMethod.GET)
    public  String gotoBusinesslAddNode(String value,HttpServletRequest request){
    	request.setAttribute("value", value);
    	return "business/addNode";	
    }
    
    /**
    * @Title: gotoBusinesslAddNode 
    * @Description:修改业务模板跳转
    * @param @param value
    * @param @param request
    * @param @return
    * @author hechunyang 
    * @return String    返回类型 
    * @throws
     */
    @RequestMapping(value="forward/gotoUpdateProceTemp",method=RequestMethod.GET)
    public  String gotoUpdateProceTemp(HttpServletRequest request,Integer processTmpId){
    	request.setAttribute("processTmpId", processTmpId);
    	List<Map<String,Object>> mntProcessInfoTmp=processManageService.getProcessTemp(processTmpId);
    	request.setAttribute("processInfoTmp", mntProcessInfoTmp);
    	return "business/updateProceTemp";	
    }
    
    @RequestMapping(value="forward/gotoHelpTogether",method=RequestMethod.GET)
    public  String gotoHelpTogether(HttpServletRequest request,Integer processTmpId,Integer nodeId){
    	request.setAttribute("processTmpId", processTmpId);
    	request.setAttribute("nodeId", nodeId);
    	return "business/updateTogether";	
    }
    
	/***
	 * zhouwenwen
	 */
    
    /**
     * 获取流程列表
     * 
     */
    @RequestMapping(value = "/asyn/getProcessList", method = RequestMethod.POST)
    @ResponseBody
    public Map<String, Object> getProcessList(HttpSession session, String processName, String cusName,String conType, PageInfo info)
    {
    	
        final MntMember member = (MntMember)session.getAttribute("userInfo");
        final int mngId = member.getOrgId();
        //判断是不是管理员 
        boolean isAdmin = member.isAdmin();
        int adminId = member.getEmpInfo().getId();
        try {
        	cusName =URLDecoder.decode(cusName,"UTF-8");
        	processName =URLDecoder.decode(processName,"UTF-8");
		} catch (UnsupportedEncodingException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
        final PageUtil util = iProcessInfoManageService.getProcessList(mngId, processName, cusName,conType,isAdmin ,adminId, info );
        return util.initResult();
    }
    
    /**
     * 获取流程下环节
     * 
     */
    @RequestMapping(value = "/asyn/getNodeList", method = RequestMethod.GET)
    @ResponseBody
    public Map<String, Object> getNodeList(HttpSession session, String processId, PageInfo info)
    {
    	System.out.println(processId);
    	Map<String, Object> result = new HashMap<String, Object>();
        final MntMember member = (MntMember)session.getAttribute("userInfo");
        final PageUtil util = iProcessInfoManageService.getNodeList(processId, info);
      
        return util.initResult();
    }
    
    
    /*
     * 启动环节
     * 参数列表：环节id，状态
     */
    
    @RequestMapping(value = "asyn/startNode", method = RequestMethod.POST)
    @ResponseBody
    public Map<String, Object> startNode(HttpSession session,String processId, String nodeId,String nodeStatus)
    {
        Map<String, Object> result = new HashMap<String, Object>();
        final MntMember member = (MntMember)session.getAttribute("userInfo");
        final int mngId = member.getOrgId();
        final int code = iProcessInfoManageService.updateNode(processId,nodeId,nodeStatus);
        result.put("code", code);
        return result;
    }
    
    /*
     * 交接环节
     * 参数列表：环节id，状态
     */
    
    @RequestMapping(value = "asyn/commitNode", method = RequestMethod.POST)
    @ResponseBody
    public Map<String, Object> commitNode(HttpSession session,HttpServletRequest request,String processId, String nodeId,String nodeStatus,PageInfo info)
    {
    	final MntMember member = (MntMember)session.getAttribute("userInfo");
    	// 查询协同人员和下一个处理人员
    	info.setPage(0);
    	info.setRows(50);
    	PageUtil page = iProcessInfoManageService.getDealNodeMan(processId,nodeId ,info);
    	List record = page.getRecords();
    	String beforeNodeId ="" ;
    	String afterNodeId ="" ;
    	for(int i = 0 ; i<record.size();i++){
    		Map map = (Map) record.get(i);
    		beforeNodeId = (String) map.get("beforeNodeId");
    		afterNodeId = (String) map.get("afterNodeId");
    	}
    	String beforeName ="";
    	String beforeTelphone ="";
    	Integer beforeAdminId = 0;
    	
    	//通过processId，beforeNodeId 查询协同人员
    	PageUtil pageBefore = iProcessInfoManageService.getBeforeMan(processId,nodeId,beforeNodeId ,info);
    	List beforeList = pageBefore.getRecords();
    	//获取人员信息 
    	
    	for(int i = 0 ; i<beforeList.size();i++){
    		Map map = (Map) beforeList.get(i);
    		beforeAdminId = (Integer)map.get("adminId");
    		beforeName = (String) map.get("Name");
    		beforeTelphone = (String) map.get("Telphone");
    		System.out.println("beforeAdminId:"+beforeAdminId);
    		
    		// 交接之前 推送webapp提醒  start
       	 	final String message = "您的协同环节已经完成,请执行您的环节！点击本条消息处理该请求！";
            final String tabname = "流程处理";
            final String path = "business/progressList";
            final MsgNotification mnc = new MsgNotification(null, message, path, 0, new Date(), null, beforeAdminId, tabname, 1,beforeTelphone);
            mnc.setDepartmentId("0");
            frameworkSer.insertMsgNotification(mnc);
            // 交接之前 推送webapp提醒  end
            
            
        	// 交接之前 推送短信提醒 start
//       	 beforeTelphone = "18600992681";
//            Map<String, Object> map = SMSSender.sendfeeNotice(beforeTelphone,
//   					new String[] { message });
         // 交接之前 推送短信提醒 end
            
    	}
    	
    	String afterName = "";
    	String afterTelphone = "" ;
    	//通过processId，afterNodeId 查询下一个处理人
    	
    	//afterNodeId 格式：1&2&3
    	String[] afterNodeIds = afterNodeId.split(",");//解析afterNodeId
    	for(int i =0 ; i <afterNodeIds.length;i++){
    		PageUtil pageAfter = iProcessInfoManageService.getAfterMan(processId,afterNodeIds[i] ,info);
    		List afterList = pageAfter.getRecords();
    		//获取人员信息 
        	
        	for(int j = 0 ; j<afterList.size();j++){
        		Map map = (Map) afterList.get(j);
        		Integer afterAdminId = (Integer)map.get("adminId");
        		afterName = (String) map.get("Name");
        		afterTelphone = (String) map.get("Telphone");
        		System.out.println("afterAdminId:"+afterAdminId);
        		
        		
        		// 交接之前 推送webapp提醒  start
           	 	final String message = "您的上级环节已经执行完成,请执行您的环节！点击本条消息处理该请求！";
                final String tabname = "流程处理";
                final String path = "business/progressList";
                final MsgNotification mnc = new MsgNotification(null, message, path, 0, new Date(), null, afterAdminId, tabname, 1,afterTelphone);
                mnc.setDepartmentId("0");
                frameworkSer.insertMsgNotification(mnc);
                // 交接之前 推送webapp提醒  end
                
                
            	// 交接之前 推送短信提醒 start
//           	 beforeTelphone = "18600992681";
//                Map<String, Object> map = SMSSender.sendfeeNotice(beforeTelphone,
//       					new String[] { message });
             // 交接之前 推送短信提醒 end
        	}
    	}
         
        Map<String, Object> result = new HashMap<String, Object>();
        final int code = iProcessInfoManageService.updateNode(processId,nodeId,nodeStatus);
        result.put("code", code);
        return result;
    }
    
    public static void main(String[] args) {
		String node = "1&";
		String[] a = node.split("&");
		System.out.println(a.length);
		
	}
    
    /**
     * 获取登录人部门下的流程环节
     * 
     */
    @RequestMapping(value = "/asyn/getDepartmentNodeList", method = RequestMethod.GET)
    @ResponseBody
    public Map<String, Object> getDepartmentNodeList(HttpSession session, String processId, PageInfo info)
    {
    	Map<String, Object> result = new HashMap<String, Object>();
        final MntMember member = (MntMember)session.getAttribute("userInfo");
        final int mngId = member.getOrgId();
        //判断是不是管理员 
        boolean isAdmin = member.isAdmin();
        int adminId = member.getEmpInfo().getId();
        String departmentId = member.getDepartmentId();
        System.out.println("departmentId:"+departmentId);
    	System.out.println(processId);
        final PageUtil util = iProcessInfoManageService.getDepartmentNodeList(processId,departmentId,isAdmin,adminId, info);
        return util.initResult();
    }
    
    
    /**
     * 根据部门id获取该部门id的所有有效员工
     * 参数：业务id（防止以后使用）,环节id（防止以后使用），部门id
     */
    @RequestMapping(value = "/asyn/getDepartmentUserList", method = RequestMethod.GET)
    @ResponseBody
    public Map<String, Object> getDepartmentUserList(HttpSession session, String processId,String nodeId,String departmentId,String name , String tel, PageInfo info)
    {
    	try {
			name = URLDecoder.decode(name,"UTF-8");
			tel = URLDecoder.decode(tel,"UTF-8");
		} catch (UnsupportedEncodingException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
    	final MntMember member = (MntMember)session.getAttribute("userInfo");
    	 boolean isAdmin = member.isAdmin();
         int adminId = member.getEmpInfo().getId();
    	System.out.println("name:"+name);
    	System.out.println("tel:"+tel);
        final PageUtil util = iProcessInfoManageService.getDepartmentUserList(departmentId,name,tel,isAdmin,adminId, info);
        return util.initResult();
    }
    
    
    
    /*
     * 重新指派环节
     * 参数列表：业务id，环节id，员工手机号
     */
    
    @RequestMapping(value = "asyn/reAppoint", method = RequestMethod.POST)
    @ResponseBody
    public Map<String, Object> reAppoint(HttpSession session,String processId, String nodeId,String clerkTel,PageInfo info)
    {
    	info.setPage(0);
    	info.setRows(50);
    	// 根据clerkTel获取人员id 
    	PageUtil pageMember = iProcessInfoManageService.getMemberInfoByTel(clerkTel,info);
    	List listMember = pageMember.getRecords();
    	String id ="" ;
    	for(int l = 0 ;l<listMember.size();l++){
    		Map map = (Map) listMember.get(l);
    		id = (Integer)map.get("id")+"";
    	}
        Map<String, Object> result = new HashMap<String, Object>();
        final MntMember member = (MntMember)session.getAttribute("userInfo");
        final int mngId = member.getOrgId();
        final int code = iProcessInfoManageService.updateReAppoint(processId,nodeId,id);
        if(code==0){//指派成功
        	//根据id获取人员信息 id为adminid
        	info.setPage(0);
        	info.setRows(50);
        	PageUtil page = iProcessInfoManageService.getMemberInfo(id,info);
        	List record = page.getRecords();
        	Integer userId = 0;
        	String name="";
        	String telphone = "";
        	for(int i = 0 ; i<record.size();i++){
        		Map map = (Map) record.get(i);
        		userId = (Integer)map.get("id");
        		name= (String) map.get("Name");
        		telphone = (String) map.get("Telphone");
        	}
        		
        	// 重新指派之后 推送webapp提醒  start
        	final String message =name+"，您好！有新环节指派给您,请执行您的环节！点击本条消息处理该请求！";
            final String tabname = "环节重新指派";
            final String path = "business/progressList";
            final MsgNotification mnc = new MsgNotification(null, message, path, 0, new Date(), null, userId, tabname, 1,telphone);
            mnc.setDepartmentId("0");
            frameworkSer.insertMsgNotification(mnc);
            // 重新指派之后 推送webapp提醒  end
        	// 重新指派之后 推送短信提醒 
        }
       
        result.put("code", code);
        
        
        return result;
    }
    
    
    
    
    /**
     * 获取流程操作数据-主要作为加载流程图使用
     * 
     */
    @RequestMapping(value = "/asyn/getflowDate", method = RequestMethod.POST)
    @ResponseBody
    public Map<String, Object> getflowDate(HttpSession session, String processId, PageInfo info)
    {
    	info.setPage(0);
    	info.setRows(50);
    	final PageUtil util = iProcessInfoManageService.getNodeList(processId, info);
        Map<String, Object> result = new HashMap<String, Object>();
        //String array = JSONArray.toJSONString(util.getRecords());
        //System.out.println("array:"+array);
        
        
        result.put("flowDate", util.getRecords());
        return result;
    }
	
}
