package com.wb.component.mobile.pushMessage.job;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.hibernate.Criteria;
import org.hibernate.Query;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;

import com.wb.component.mobile.push.PushUtil;
import com.wb.component.mobile.pushMessage.service.IPushMessageService;
import com.wb.model.entity.computer.MntMember;

public class Job {
	
	@Autowired
	@Qualifier("pushMessageService")
	private IPushMessageService pushMessageService;
	/*
	 * wangyanlong
	 */
	public void initPower() {
		
	}
	
	/**
	 * 
	 * @author sunxu
	 */
	public void pushM() {
		Calendar a = Calendar.getInstance();
		System.out.println("批量推送任务进行中。。。");
		String payYear = a.get(Calendar.YEAR) + "";
		int nowDate = a.get(Calendar.DATE);
		int lastThreeDay = pushMessageService.getLastThreeDay();
		
		//查询所有小微企业--开始
		List<Map<String, Object>> list = pushMessageService.selectAllCompany(payYear);
		//查询所有小微企业--结束
		if (list != null) {

			for (Map<String, Object> map : list) {
				String payMonths = map.get("PAYMONTHS").toString();
				if (payMonths != null && !"".equals(payMonths)) {
					payMonths = pushMessageService.checkDupArray(payMonths.split(","));// 由于sql语句查出来月份会重复此处去重排序;
					map.put("PAYMONTHS", payMonths);
				}
				String bMonths = map.get("BMONTHS").toString();
				String eMonths = map.get("EMONTHS").toString();
				boolean isArr = pushMessageService.checkIfConPayMonthsArr(bMonths, eMonths, payMonths, payYear);// 是否欠费
				boolean isEnd = pushMessageService.checkIfConPayMonthsEnd(eMonths, payMonths, payYear);// 是否即将到期
				if (!isArr) {
					if (isEnd) {
						String androidDeviceToken = map.get("ANDROIDDEVICETOKEN").toString();
						String iosDeviceToken = map.get("IOSDEVICETOKEN").toString();
						if (nowDate >= lastThreeDay) {
							if (androidDeviceToken != null && !androidDeviceToken.equals("")) {
								ArrayList<Map> androidListArgs = new ArrayList<Map>();
								Map temp = new HashMap();
								temp.put("type", "1");
								androidListArgs.add(temp);

								try {
									PushUtil.sendAndroidUnicast(androidDeviceToken, "testticket", "理财金服",
											"您的代理记账费用还有" + (3 - (nowDate - lastThreeDay)) + "天到期，请及时进行充值",
											androidListArgs);
								} catch (Exception e) {
									System.out.println("发送android推送信息失败");
									e.printStackTrace();
								}
							}

							if (iosDeviceToken != null && !iosDeviceToken.equals("")) {
								ArrayList<Map> iosListArgs = new ArrayList<Map>();
								Map iosTemp = new HashMap();
								iosTemp.put("type", "1");
								iosListArgs.add(iosTemp);
								// badge是消息总数 开始
								Date date = new Date();
								SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
								String str = sdf.format(date);
								String mntCustomId = map.get("MNTCUSTOMID").toString();
								String iosDeviceTokenForInsert = map.get("IOSDEVICETOKEN").toString();
								pushMessageService.insertMessage(nowDate, lastThreeDay, str, mntCustomId, iosDeviceTokenForInsert);
								// 插入结束,查询消息总数badge开始
								int badge = pushMessageService.selectMessageNum(iosDeviceTokenForInsert);
								
								// 查询消息总数badge结束

								try {
									PushUtil.sendIOSUnicast(iosDeviceToken,
											"您的代理记账费用还有" + (3 - (nowDate - lastThreeDay)) + "天到期，请及时进行充值", iosListArgs,
											badge);
								} catch (Exception e) {
									System.out.println("发送ios推送信息失败");
									e.printStackTrace();
								}
								// 所有未读信息改为已读信息--开始
								pushMessageService.updateMessagestate(iosDeviceTokenForInsert);
								// 所有未读信息改为已读信息--结束
							}
						}
					}
				}
			}
		}
	}
}
